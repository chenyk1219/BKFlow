# èŠ‚ç‚¹è¾“å‡ºå¼•ç”¨æŒ‡å—

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜å¦‚ä½•åœ¨ bamboo-engine ä¸­å¼•ç”¨å‰ä¸€ä¸ªèŠ‚ç‚¹çš„è¾“å‡ºæ•°æ®ã€‚

---

## â“ æ ¸å¿ƒé—®é¢˜

**åä¸€ä¸ªç»„ä»¶ä½¿ç”¨å‰ä¸€ä¸ªç»„ä»¶çš„è¾“å‡ºå¯ä»¥ç›´æ¥ä½¿ç”¨ `${xxxx}` å—ï¼Œè¿˜æ˜¯è¦åŠ ä¸Š node IDï¼Ÿ**

### ç­”æ¡ˆ

âŒ **ä¸èƒ½ç›´æ¥ä½¿ç”¨ `${xxxx}`**

âœ… **å¿…é¡»é€šè¿‡ `NodeOutput` åœ¨å…¨å±€æ•°æ®ä¸Šä¸‹æ–‡ä¸­å£°æ˜èŠ‚ç‚¹è¾“å‡ºçš„å¼•ç”¨å…³ç³»**

âœ… **éœ€è¦ä½¿ç”¨ node ID**ï¼ˆé€šè¿‡ `source_act` å‚æ•°æŒ‡å®šï¼‰

---

## ğŸ¯ æ­£ç¡®çš„ä¸‰æ­¥æµç¨‹

### æ­¥éª¤ 1ï¼šå‰ä¸€ä¸ªèŠ‚ç‚¹è¾“å‡ºæ•°æ®

```python
# å‰ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆä¾‹å¦‚ï¼šGit è·å–æäº¤ä¿¡æ¯ï¼‰
git_act = ServiceActivity(component_code='git_get_commit')

# åœ¨ Service.execute() ä¸­è¾“å‡ºæ•°æ®
class GitGetCommitService(Service):
    def execute(self, data, parent_data):
        # è·å– git commit id
        commit_id = 'abc123def456'
        
        # â­ å…³é”®ï¼šè¾“å‡ºåˆ°èŠ‚ç‚¹æ•°æ®
        data.outputs.commit_id = commit_id
        
        return True
```

### æ­¥éª¤ 2ï¼šåœ¨å…¨å±€æ•°æ®ä¸Šä¸‹æ–‡ä¸­å£°æ˜ NodeOutput

```python
from bamboo_engine.builder import NodeOutput, Data

# åˆ›å»ºæµç¨‹æ•°æ®
pipeline_data = Data()

# â­â­â­ å…³é”®æ­¥éª¤ï¼šä½¿ç”¨ NodeOutput å£°æ˜å¼•ç”¨å…³ç³»
pipeline_data.inputs['${commit_id}'] = NodeOutput(
    source_act=git_act.id,      # â† æºèŠ‚ç‚¹çš„ IDï¼ˆå¿…é¡»ï¼‰
    source_key='commit_id',     # â† æºèŠ‚ç‚¹è¾“å‡ºçš„ keyï¼ˆå¿…é¡»ï¼‰
    type=Var.SPLICE             # â† å˜é‡ç±»å‹
)
```

### æ­¥éª¤ 3ï¼šåä¸€ä¸ªèŠ‚ç‚¹å¼•ç”¨è¿™ä¸ªå˜é‡

```python
# åä¸€ä¸ªèŠ‚ç‚¹ï¼ˆJenkins æ„å»ºï¼‰
jenkins_act = ServiceActivity(component_code='jenkins_job_execute')

# ä½¿ç”¨ ${commit_id} å¼•ç”¨
jenkins_act.component.inputs.job_parameters = Var(
    type=Var.SPLICE,
    value={
        'commit_id': '${commit_id}',  # â† å¼•ç”¨å…¨å±€å˜é‡
        'branch': 'master',
    }
)
```

---

## ğŸ” ä¸ºä»€ä¹ˆå¿…é¡»ä½¿ç”¨ NodeOutputï¼Ÿ

### åŸå›  1ï¼šå¼•æ“éœ€è¦çŸ¥é“æ•°æ®ä¾èµ–å…³ç³»

```python
# âŒ é”™è¯¯åšæ³•ï¼šç›´æ¥ä½¿ç”¨ ${commit_id}
jenkins_act.component.inputs.job_parameters = Var(
    type=Var.SPLICE,
    value={'commit_id': '${commit_id}'}  # å¼•æ“ä¸çŸ¥é“è¿™ä¸ªå˜é‡æ¥è‡ªå“ªé‡Œï¼
)

# âœ… æ­£ç¡®åšæ³•ï¼šé€šè¿‡ NodeOutput å£°æ˜
pipeline_data.inputs['${commit_id}'] = NodeOutput(
    source_act=git_act.id,      # å‘Šè¯‰å¼•æ“ï¼šè¿™ä¸ªå˜é‡æ¥è‡ª git_act èŠ‚ç‚¹
    source_key='commit_id'      # å‘Šè¯‰å¼•æ“ï¼šå– git_act è¾“å‡ºçš„ commit_id å­—æ®µ
)
```

### åŸå›  2ï¼šå¼•æ“éœ€è¦åœ¨æ­£ç¡®çš„æ—¶æœºæ›´æ–°å˜é‡å€¼

```
æ‰§è¡Œæµç¨‹ï¼š
1. git_act æ‰§è¡Œ
2. git_act.outputs.commit_id = 'abc123def456'
3. å¼•æ“çœ‹åˆ° NodeOutput å£°æ˜ï¼Œæ›´æ–°å…¨å±€å˜é‡
   ${commit_id} â† 'abc123def456'
4. jenkins_act æ‰§è¡Œ
5. æ¸²æŸ“ ${commit_id} â†’ 'abc123def456'
```

### åŸå›  3ï¼šæ”¯æŒå¤æ‚çš„æ•°æ®æµè½¬

NodeOutput è®©å¼•æ“èƒ½å¤Ÿï¼š
- è¿½è¸ªæ•°æ®æ¥æº
- ç®¡ç†èŠ‚ç‚¹æ‰§è¡Œé¡ºåº
- å¤„ç†å¹¶è¡ŒèŠ‚ç‚¹çš„è¾“å‡º
- æ”¯æŒå­æµç¨‹çš„è¾“å‡ºå¼•ç”¨

---

## ğŸ“Š å®Œæ•´ç¤ºä¾‹

### ç¤ºä¾‹ 1ï¼šåŸºç¡€ç”¨æ³• - Git â†’ Jenkins

```python
from bamboo_engine.builder import (
    Var, Data, ServiceActivity, NodeOutput,
    EmptyStartEvent, EmptyEndEvent, builder
)
from bamboo_engine import api
from bamboo_engine.eri.runtime import BambooDjangoRuntime

# ========== 1. åˆ›å»ºèŠ‚ç‚¹ ==========
start = EmptyStartEvent()

# èŠ‚ç‚¹ 1ï¼šè·å– Git æäº¤ä¿¡æ¯
git_act = ServiceActivity(component_code='git_get_commit', name='è·å–æäº¤ä¿¡æ¯')
git_act.component.inputs.repository = Var(
    type=Var.PLAIN,
    value='https://github.com/example/app.git'
)

# èŠ‚ç‚¹ 2ï¼šJenkins æ„å»º
jenkins_act = ServiceActivity(component_code='jenkins_job_execute', name='Jenkinsæ„å»º')
jenkins_act.component.inputs.jenkins_url = Var(type=Var.PLAIN, value='http://jenkins.example.com')
jenkins_act.component.inputs.job_name = Var(type=Var.PLAIN, value='build-app')
jenkins_act.component.inputs.username = Var(type=Var.PLAIN, value='admin')
jenkins_act.component.inputs.password = Var(type=Var.PLAIN, value='token123')

# â­ å¼•ç”¨å‰ä¸€ä¸ªèŠ‚ç‚¹çš„è¾“å‡º
jenkins_act.component.inputs.job_parameters = Var(
    type=Var.SPLICE,
    value={
        'commit_id': '${commit_id}',  # å¼•ç”¨ git_act çš„è¾“å‡º
        'branch': 'master',
    }
)

end = EmptyEndEvent()

# ========== 2. è¿æ¥èŠ‚ç‚¹ ==========
start.extend(git_act).extend(jenkins_act).extend(end)

# ========== 3. åˆ›å»ºå…¨å±€æ•°æ®ä¸Šä¸‹æ–‡ ==========
pipeline_data = Data()

# â­â­â­ å…³é”®ï¼šå£°æ˜ NodeOutput
pipeline_data.inputs['${commit_id}'] = NodeOutput(
    source_act=git_act.id,      # git_act èŠ‚ç‚¹çš„ ID
    source_key='commit_id',     # git_act è¾“å‡ºçš„å­—æ®µå
    type=Var.SPLICE             # å˜é‡ç±»å‹
)

# ========== 4. æ„å»ºå¹¶æ‰§è¡Œ ==========
pipeline = builder.build_tree(start, data=pipeline_data)
api.run_pipeline(runtime=BambooDjangoRuntime(), pipeline=pipeline)
```

### ç¤ºä¾‹ 2ï¼šå¼•ç”¨å¤šä¸ªèŠ‚ç‚¹çš„è¾“å‡º

```python
# èŠ‚ç‚¹ 1ï¼šè·å–ä»£ç 
git_act = ServiceActivity(component_code='git_clone', name='å…‹éš†ä»£ç ')

# èŠ‚ç‚¹ 2ï¼šè¿è¡Œæµ‹è¯•
test_act = ServiceActivity(component_code='run_tests', name='è¿è¡Œæµ‹è¯•')

# èŠ‚ç‚¹ 3ï¼šJenkins éƒ¨ç½²ï¼ˆå¼•ç”¨å‰ä¸¤ä¸ªèŠ‚ç‚¹çš„è¾“å‡ºï¼‰
jenkins_act = ServiceActivity(component_code='jenkins_job_execute', name='éƒ¨ç½²åº”ç”¨')
jenkins_act.component.inputs.job_parameters = Var(
    type=Var.SPLICE,
    value={
        'commit_id': '${commit_id}',      # æ¥è‡ª git_act
        'test_result': '${test_result}',  # æ¥è‡ª test_act
        'branch': 'master',
    }
)

# è¿æ¥èŠ‚ç‚¹
start.extend(git_act).extend(test_act).extend(jenkins_act).extend(end)

# å£°æ˜å¤šä¸ª NodeOutput
pipeline_data = Data()
pipeline_data.inputs['${commit_id}'] = NodeOutput(
    source_act=git_act.id,
    source_key='commit_id',
    type=Var.SPLICE
)
pipeline_data.inputs['${test_result}'] = NodeOutput(
    source_act=test_act.id,
    source_key='result',
    type=Var.SPLICE
)
```

### ç¤ºä¾‹ 3ï¼šæ··åˆä½¿ç”¨å…¨å±€å˜é‡å’ŒèŠ‚ç‚¹è¾“å‡º

```python
# å…¨å±€å˜é‡
pipeline_data = Data()
pipeline_data.inputs['${deploy_env}'] = Var(type=Var.PLAIN, value='production')

# èŠ‚ç‚¹è¾“å‡ºå¼•ç”¨
pipeline_data.inputs['${commit_id}'] = NodeOutput(
    source_act=git_act.id,
    source_key='commit_id',
    type=Var.SPLICE
)

# Jenkins èŠ‚ç‚¹åŒæ—¶ä½¿ç”¨å…¨å±€å˜é‡å’ŒèŠ‚ç‚¹è¾“å‡º
jenkins_act.component.inputs.job_parameters = Var(
    type=Var.SPLICE,
    value={
        'commit_id': '${commit_id}',      # æ¥è‡ª git_act èŠ‚ç‚¹è¾“å‡º
        'environment': '${deploy_env}',   # æ¥è‡ªå…¨å±€å˜é‡
        'branch': 'master',               # é™æ€å€¼
    }
)
```

### ç¤ºä¾‹ 4ï¼šJenkins ç»„ä»¶çš„å®Œæ•´ç¤ºä¾‹

```python
from bamboo_engine.builder import *
from bamboo_engine import api
from bamboo_engine.eri.runtime import BambooDjangoRuntime

# ========== å®šä¹‰ç»„ä»¶ ==========
# Git ç»„ä»¶
class GitGetCommitService(Service):
    def execute(self, data, parent_data):
        repository = data.get_one_of_inputs('repository')

        # æ¨¡æ‹Ÿè·å– commit id
        commit_id = 'abc123def456'
        commit_message = 'Fix bug in login module'
        commit_author = 'developer@example.com'

        # è¾“å‡ºæ•°æ®
        data.outputs.commit_id = commit_id
        data.outputs.commit_message = commit_message
        data.outputs.commit_author = commit_author

        return True

    def inputs_format(self):
        return [
            InputItem(
                name='ä»“åº“åœ°å€',
                key='repository',
                type='string',
                required=True,
                schema=StringItemSchema(description='Git ä»“åº“åœ°å€')
            )
        ]

    def outputs_format(self):
        return [
            OutputItem(
                name='æäº¤ID',
                key='commit_id',
                type='string',
                schema=StringItemSchema(description='Git æäº¤ ID')
            ),
            OutputItem(
                name='æäº¤ä¿¡æ¯',
                key='commit_message',
                type='string',
                schema=StringItemSchema(description='æäº¤ä¿¡æ¯')
            ),
            OutputItem(
                name='æäº¤ä½œè€…',
                key='commit_author',
                type='string',
                schema=StringItemSchema(description='æäº¤ä½œè€…')
            )
        ]

# ========== æ„å»ºæµç¨‹ ==========
start = EmptyStartEvent()

# Git èŠ‚ç‚¹
git_act = ServiceActivity(component_code='git_get_commit', name='è·å–æäº¤ä¿¡æ¯')
git_act.component.inputs.repository = Var(
    type=Var.PLAIN,
    value='https://github.com/example/app.git'
)

# Jenkins èŠ‚ç‚¹
jenkins_act = ServiceActivity(component_code='jenkins_job_execute', name='Jenkinsæ„å»º')
jenkins_act.component.inputs.jenkins_url = Var(type=Var.PLAIN, value='http://jenkins.example.com')
jenkins_act.component.inputs.job_name = Var(type=Var.PLAIN, value='build-app')
jenkins_act.component.inputs.username = Var(type=Var.PLAIN, value='admin')
jenkins_act.component.inputs.password = Var(type=Var.PLAIN, value='token123')

# å¼•ç”¨ Git èŠ‚ç‚¹çš„å¤šä¸ªè¾“å‡º
jenkins_act.component.inputs.job_parameters = Var(
    type=Var.SPLICE,
    value={
        'GIT_COMMIT': '${commit_id}',           # å¼•ç”¨ commit_id
        'GIT_MESSAGE': '${commit_message}',     # å¼•ç”¨ commit_message
        'GIT_AUTHOR': '${commit_author}',       # å¼•ç”¨ commit_author
        'BUILD_TYPE': 'release',
        'ENABLE_TEST': True,
    }
)

end = EmptyEndEvent()

# è¿æ¥èŠ‚ç‚¹
start.extend(git_act).extend(jenkins_act).extend(end)

# å£°æ˜ NodeOutput
pipeline_data = Data()
pipeline_data.inputs['${commit_id}'] = NodeOutput(
    source_act=git_act.id,
    source_key='commit_id',
    type=Var.SPLICE
)
pipeline_data.inputs['${commit_message}'] = NodeOutput(
    source_act=git_act.id,
    source_key='commit_message',
    type=Var.SPLICE
)
pipeline_data.inputs['${commit_author}'] = NodeOutput(
    source_act=git_act.id,
    source_key='commit_author',
    type=Var.SPLICE
)

# æ„å»ºå¹¶æ‰§è¡Œ
pipeline = builder.build_tree(start, data=pipeline_data)
api.run_pipeline(runtime=BambooDjangoRuntime(), pipeline=pipeline)
```

---

## ğŸŒ³ åœ¨ Pipeline Tree ä¸­çš„è¡¨ç¤º

### ä½¿ç”¨ NodeOutput åçš„ Pipeline Tree

```json
{
    "data": {
        "inputs": {
            "${commit_id}": {
                "type": "splice",
                "source_act": "n001",      // â† git_act çš„ ID
                "source_key": "commit_id", // â† è¾“å‡ºå­—æ®µå
                "value": null              // â† åˆå§‹å€¼ä¸º null
            }
        }
    },
    "activities": {
        "n001": {
            "id": "n001",
            "name": "è·å–æäº¤ä¿¡æ¯",
            "component": {
                "code": "git_get_commit",
                "inputs": {
                    "repository": {
                        "type": "plain",
                        "value": "https://github.com/example/app.git"
                    }
                }
            }
        },
        "n002": {
            "id": "n002",
            "name": "Jenkinsæ„å»º",
            "component": {
                "code": "jenkins_job_execute",
                "inputs": {
                    "job_parameters": {
                        "type": "splice",
                        "value": {
                            "commit_id": "${commit_id}"  // â† å¼•ç”¨å…¨å±€å˜é‡
                        }
                    }
                }
            }
        }
    }
}
```

---

## ğŸ”„ æ‰§è¡Œæµç¨‹è¯¦è§£

### å®Œæ•´çš„æ•°æ®æµè½¬è¿‡ç¨‹

```
1. å¼•æ“å¼€å§‹æ‰§è¡Œ git_act
   â†“
2. git_act.execute() è¿è¡Œ
   data.outputs.commit_id = 'abc123def456'
   data.outputs.commit_message = 'Fix bug'
   â†“
3. git_act æ‰§è¡Œå®Œæˆ
   â†“
4. å¼•æ“æ›´æ–°å…¨å±€å˜é‡ï¼ˆå› ä¸ºæœ‰ NodeOutput å£°æ˜ï¼‰
   ${commit_id} â† 'abc123def456'
   ${commit_message} â† 'Fix bug'
   â†“
5. å¼•æ“å¼€å§‹æ‰§è¡Œ jenkins_act
   â†“
6. å¼•æ“æ¸²æŸ“ jenkins_act çš„è¾“å…¥
   'commit_id': '${commit_id}' â†’ 'commit_id': 'abc123def456'
   'commit_message': '${commit_message}' â†’ 'commit_message': 'Fix bug'
   â†“
7. jenkins_act.execute() æ¥æ”¶åˆ°æ¸²æŸ“åçš„å€¼
   job_parameters = {
       'commit_id': 'abc123def456',
       'commit_message': 'Fix bug',
       'branch': 'master'
   }
   â†“
8. jenkins_act ä½¿ç”¨è¿™äº›å‚æ•°è°ƒç”¨ Jenkins API
```

### æ—¶åºå›¾

```
GitèŠ‚ç‚¹          å¼•æ“              å…¨å±€å˜é‡           JenkinsèŠ‚ç‚¹
  |              |                  |                  |
  |--æ‰§è¡Œ------->|                  |                  |
  |              |                  |                  |
  |--è¾“å‡ºæ•°æ®--->|                  |                  |
  |  commit_id   |                  |                  |
  |              |                  |                  |
  |              |--æ›´æ–°å˜é‡------->|                  |
  |              |  ${commit_id}    |                  |
  |              |                  |                  |
  |              |                  |<--è¯»å–å˜é‡-------|
  |              |                  |  ${commit_id}    |
  |              |                  |                  |
  |              |--æ¸²æŸ“åçš„å€¼---------------->|
  |              |  'abc123def456'            |
  |              |                            |
  |              |                            |--æ‰§è¡Œ-->
```

---

## âš ï¸ å¸¸è§é”™è¯¯åŠè§£å†³æ–¹æ¡ˆ

### é”™è¯¯ 1ï¼šå¿˜è®°å£°æ˜ NodeOutput

**é”™è¯¯ä»£ç **ï¼š
```python
# âŒ é”™è¯¯ï¼šåªåœ¨ç»„ä»¶ä¸­å¼•ç”¨ï¼Œæ²¡æœ‰å£°æ˜ NodeOutput
jenkins_act.component.inputs.job_parameters = Var(
    type=Var.SPLICE,
    value={'commit_id': '${commit_id}'}
)

# æ²¡æœ‰è¿™ä¸€è¡Œï¼
# pipeline_data.inputs['${commit_id}'] = NodeOutput(...)
```

**é”™è¯¯ç°è±¡**ï¼š
- `${commit_id}` æ— æ³•è§£æ
- ä¿æŒåŸæ · `"${commit_id}"` æˆ–æŠ¥é”™ "å˜é‡æœªå®šä¹‰"

**æ­£ç¡®åšæ³•**ï¼š
```python
# âœ… æ­£ç¡®ï¼šå¿…é¡»å£°æ˜ NodeOutput
pipeline_data.inputs['${commit_id}'] = NodeOutput(
    source_act=git_act.id,
    source_key='commit_id',
    type=Var.SPLICE
)
```

---

### é”™è¯¯ 2ï¼šsource_key å†™é”™

**é”™è¯¯ä»£ç **ï¼š
```python
# Git ç»„ä»¶è¾“å‡º
class GitGetCommitService(Service):
    def execute(self, data, parent_data):
        data.outputs.commit_id = 'abc123'  # â† è¾“å‡ºçš„ key æ˜¯ 'commit_id'
        return True

# âŒ é”™è¯¯ï¼šsource_key å†™é”™äº†
pipeline_data.inputs['${commit_id}'] = NodeOutput(
    source_act=git_act.id,
    source_key='commit'  # â† é”™è¯¯ï¼åº”è¯¥æ˜¯ 'commit_id'
)
```

**é”™è¯¯ç°è±¡**ï¼š
- æ‰¾ä¸åˆ°å¯¹åº”çš„è¾“å‡ºå­—æ®µ
- å˜é‡å€¼ä¸ºç©ºæˆ–æŠ¥é”™

**æ­£ç¡®åšæ³•**ï¼š
```python
# âœ… æ­£ç¡®ï¼šsource_key å¿…é¡»ä¸è¾“å‡ºå­—æ®µåå®Œå…¨ä¸€è‡´
pipeline_data.inputs['${commit_id}'] = NodeOutput(
    source_act=git_act.id,
    source_key='commit_id'  # â† ä¸ data.outputs.commit_id ä¸€è‡´
)
```

---

### é”™è¯¯ 3ï¼šsource_act å†™é”™

**é”™è¯¯ä»£ç **ï¼š
```python
# âŒ é”™è¯¯ï¼šä½¿ç”¨äº†é”™è¯¯çš„èŠ‚ç‚¹ ID
pipeline_data.inputs['${commit_id}'] = NodeOutput(
    source_act='wrong_id',  # â† é”™è¯¯ï¼åº”è¯¥æ˜¯ git_act.id
    source_key='commit_id'
)

# æˆ–è€…ä½¿ç”¨äº†å­—ç¬¦ä¸²è€Œä¸æ˜¯èŠ‚ç‚¹çš„ id å±æ€§
pipeline_data.inputs['${commit_id}'] = NodeOutput(
    source_act='git_act',  # â† é”™è¯¯ï¼åº”è¯¥æ˜¯ git_act.id
    source_key='commit_id'
)
```

**é”™è¯¯ç°è±¡**ï¼š
- æ‰¾ä¸åˆ°å¯¹åº”çš„èŠ‚ç‚¹
- æ— æ³•è·å–è¾“å‡ºæ•°æ®

**æ­£ç¡®åšæ³•**ï¼š
```python
# âœ… æ­£ç¡®ï¼šä½¿ç”¨èŠ‚ç‚¹çš„ id å±æ€§
pipeline_data.inputs['${commit_id}'] = NodeOutput(
    source_act=git_act.id,  # â† ä½¿ç”¨ .id å±æ€§
    source_key='commit_id'
)
```

---

### é”™è¯¯ 4ï¼šå˜é‡åä¸ä¸€è‡´

**é”™è¯¯ä»£ç **ï¼š
```python
# âŒ é”™è¯¯ï¼šå£°æ˜çš„å˜é‡åå’Œå¼•ç”¨çš„å˜é‡åä¸ä¸€è‡´
pipeline_data.inputs['${git_commit}'] = NodeOutput(  # â† å£°æ˜ä¸º ${git_commit}
    source_act=git_act.id,
    source_key='commit_id'
)

jenkins_act.component.inputs.job_parameters = Var(
    type=Var.SPLICE,
    value={'commit_id': '${commit_id}'}  # â† å¼•ç”¨çš„æ˜¯ ${commit_id}
)
```

**é”™è¯¯ç°è±¡**ï¼š
- `${commit_id}` æ— æ³•è§£æ
- åªæœ‰ `${git_commit}` å¯ç”¨

**æ­£ç¡®åšæ³•**ï¼š
```python
# âœ… æ­£ç¡®ï¼šå˜é‡åå¿…é¡»ä¸€è‡´
pipeline_data.inputs['${commit_id}'] = NodeOutput(
    source_act=git_act.id,
    source_key='commit_id'
)

jenkins_act.component.inputs.job_parameters = Var(
    type=Var.SPLICE,
    value={'commit_id': '${commit_id}'}  # â† ä¸€è‡´
)
```

---

### é”™è¯¯ 5ï¼šå¿˜è®°åœ¨ç»„ä»¶ä¸­è¾“å‡ºæ•°æ®

**é”™è¯¯ä»£ç **ï¼š
```python
# âŒ é”™è¯¯ï¼šexecute() ä¸­æ²¡æœ‰è¾“å‡ºæ•°æ®
class GitGetCommitService(Service):
    def execute(self, data, parent_data):
        commit_id = 'abc123'
        # å¿˜è®°è¾“å‡ºï¼
        # data.outputs.commit_id = commit_id
        return True

# å³ä½¿å£°æ˜äº† NodeOutput ä¹Ÿæ²¡ç”¨
pipeline_data.inputs['${commit_id}'] = NodeOutput(
    source_act=git_act.id,
    source_key='commit_id'
)
```

**é”™è¯¯ç°è±¡**ï¼š
- å˜é‡å€¼ä¸ºç©º
- åç»­èŠ‚ç‚¹è·å–ä¸åˆ°æ•°æ®

**æ­£ç¡®åšæ³•**ï¼š
```python
# âœ… æ­£ç¡®ï¼šå¿…é¡»åœ¨ execute() ä¸­è¾“å‡ºæ•°æ®
class GitGetCommitService(Service):
    def execute(self, data, parent_data):
        commit_id = 'abc123'
        data.outputs.commit_id = commit_id  # â† å¿…é¡»è¾“å‡º
        return True
```

---

## ğŸ“‹ NodeOutput å‚æ•°è¯¦è§£

### å®Œæ•´çš„å‚æ•°åˆ—è¡¨

```python
NodeOutput(
    source_act,    # å¿…éœ€ï¼šæºèŠ‚ç‚¹çš„ ID
    source_key,    # å¿…éœ€ï¼šæºèŠ‚ç‚¹è¾“å‡ºçš„å­—æ®µå
    type=Var.SPLICE,  # å¯é€‰ï¼šå˜é‡ç±»å‹ï¼Œé»˜è®¤ Var.PLAIN
    value=None     # å¯é€‰ï¼šåˆå§‹å€¼ï¼Œé€šå¸¸ä¸º None
)
```

### å‚æ•°è¯´æ˜

| å‚æ•° | ç±»å‹ | å¿…éœ€ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|------|------|
| `source_act` | string | âœ… | æºèŠ‚ç‚¹çš„ ID | `git_act.id` |
| `source_key` | string | âœ… | æºèŠ‚ç‚¹è¾“å‡ºçš„å­—æ®µå | `'commit_id'` |
| `type` | string | âŒ | å˜é‡ç±»å‹ | `Var.SPLICE` (é»˜è®¤) |
| `value` | any | âŒ | åˆå§‹å€¼ | `None` (é»˜è®¤) |

### type å‚æ•°çš„å½±å“

```python
# type=Var.PLAINï¼šç›´æ¥è¿”å›å€¼
pipeline_data.inputs['${commit_id}'] = NodeOutput(
    source_act=git_act.id,
    source_key='commit_id',
    type=Var.PLAIN  # ä¸è¿›è¡Œæ¨¡æ¿æ¸²æŸ“
)

# type=Var.SPLICEï¼šæ”¯æŒæ¨¡æ¿æ¸²æŸ“ï¼ˆæ¨èï¼‰
pipeline_data.inputs['${commit_id}'] = NodeOutput(
    source_act=git_act.id,
    source_key='commit_id',
    type=Var.SPLICE  # æ”¯æŒåœ¨å€¼ä¸­ä½¿ç”¨ ${} å¼•ç”¨
)
```

**æ³¨æ„**ï¼šé€šå¸¸ä½¿ç”¨ `Var.SPLICE`ï¼Œè¿™æ ·å¦‚æœèŠ‚ç‚¹è¾“å‡ºçš„å€¼ä¸­åŒ…å«å˜é‡å¼•ç”¨ï¼Œä¹Ÿèƒ½è¢«æ­£ç¡®æ¸²æŸ“ã€‚

---

## ğŸ¯ æœ€ä½³å®è·µ

### 1. å‘½åè§„èŒƒ

**æ¨èçš„å˜é‡å‘½åæ–¹å¼**ï¼š

```python
# âœ… æ¨èï¼šä½¿ç”¨æè¿°æ€§çš„åç§°
pipeline_data.inputs['${git_commit_id}'] = NodeOutput(...)
pipeline_data.inputs['${test_result}'] = NodeOutput(...)
pipeline_data.inputs['${build_number}'] = NodeOutput(...)

# âŒ ä¸æ¨èï¼šä½¿ç”¨æ¨¡ç³Šçš„åç§°
pipeline_data.inputs['${output1}'] = NodeOutput(...)
pipeline_data.inputs['${data}'] = NodeOutput(...)
pipeline_data.inputs['${x}'] = NodeOutput(...)
```

### 2. ç»„ç»‡ä»£ç ç»“æ„

**æ¨èçš„ä»£ç ç»„ç»‡æ–¹å¼**ï¼š

```python
# ========== 1. åˆ›å»ºæ‰€æœ‰èŠ‚ç‚¹ ==========
start = EmptyStartEvent()
git_act = ServiceActivity(component_code='git_get_commit')
test_act = ServiceActivity(component_code='run_tests')
jenkins_act = ServiceActivity(component_code='jenkins_job_execute')
end = EmptyEndEvent()

# ========== 2. é…ç½®èŠ‚ç‚¹è¾“å…¥ ==========
git_act.component.inputs.repository = Var(...)
test_act.component.inputs.test_type = Var(...)
jenkins_act.component.inputs.job_parameters = Var(...)

# ========== 3. è¿æ¥èŠ‚ç‚¹ ==========
start.extend(git_act).extend(test_act).extend(jenkins_act).extend(end)

# ========== 4. å£°æ˜å…¨å±€å˜é‡å’Œ NodeOutputï¼ˆé›†ä¸­ç®¡ç†ï¼‰ ==========
pipeline_data = Data()

# å…¨å±€å˜é‡
pipeline_data.inputs['${deploy_env}'] = Var(type=Var.PLAIN, value='production')

# èŠ‚ç‚¹è¾“å‡ºå¼•ç”¨
pipeline_data.inputs['${commit_id}'] = NodeOutput(
    source_act=git_act.id,
    source_key='commit_id',
    type=Var.SPLICE
)
pipeline_data.inputs['${test_result}'] = NodeOutput(
    source_act=test_act.id,
    source_key='result',
    type=Var.SPLICE
)

# ========== 5. æ„å»ºå¹¶æ‰§è¡Œ ==========
pipeline = builder.build_tree(start, data=pipeline_data)
```

### 3. æ³¨é‡Šè¯´æ˜

**ä¸º NodeOutput æ·»åŠ æ³¨é‡Š**ï¼š

```python
pipeline_data = Data()

# Git èŠ‚ç‚¹è¾“å‡º
pipeline_data.inputs['${commit_id}'] = NodeOutput(
    source_act=git_act.id,      # æ¥æºï¼šGit è·å–æäº¤ä¿¡æ¯èŠ‚ç‚¹
    source_key='commit_id',     # å­—æ®µï¼šæäº¤ ID
    type=Var.SPLICE
)

# æµ‹è¯•èŠ‚ç‚¹è¾“å‡º
pipeline_data.inputs['${test_result}'] = NodeOutput(
    source_act=test_act.id,     # æ¥æºï¼šè¿è¡Œæµ‹è¯•èŠ‚ç‚¹
    source_key='result',        # å­—æ®µï¼šæµ‹è¯•ç»“æœ
    type=Var.SPLICE
)
```

### 4. è¾“å‡ºå­—æ®µæ–‡æ¡£åŒ–

**åœ¨ç»„ä»¶çš„ outputs_format() ä¸­æ˜ç¡®å£°æ˜è¾“å‡ºå­—æ®µ**ï¼š

```python
class GitGetCommitService(Service):
    def outputs_format(self):
        return [
            OutputItem(
                name='æäº¤ID',
                key='commit_id',  # â† è¿™ä¸ª key ä¼šåœ¨ NodeOutput ä¸­ä½¿ç”¨
                type='string',
                schema=StringItemSchema(description='Git æäº¤çš„ SHA-1 å“ˆå¸Œå€¼')
            ),
            OutputItem(
                name='æäº¤ä¿¡æ¯',
                key='commit_message',  # â† è¿™ä¸ª key ä¼šåœ¨ NodeOutput ä¸­ä½¿ç”¨
                type='string',
                schema=StringItemSchema(description='æäº¤çš„æè¿°ä¿¡æ¯')
            )
        ]
```

è¿™æ ·å…¶ä»–å¼€å‘è€…å¯ä»¥æ¸…æ¥šåœ°çŸ¥é“å¯ä»¥å¼•ç”¨å“ªäº›è¾“å‡ºå­—æ®µã€‚

---

## ğŸ“š æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

| é—®é¢˜ | ç­”æ¡ˆ |
|------|------|
| èƒ½ç›´æ¥ä½¿ç”¨ `${xxxx}` å—ï¼Ÿ | âŒ ä¸èƒ½ |
| å¿…é¡»æ€ä¹ˆåšï¼Ÿ | âœ… ä½¿ç”¨ `NodeOutput` å£°æ˜ |
| éœ€è¦ node ID å—ï¼Ÿ | âœ… éœ€è¦ï¼ˆ`source_act` å‚æ•°ï¼‰ |
| åœ¨å“ªé‡Œå£°æ˜ï¼Ÿ | åœ¨ `pipeline_data.inputs` ä¸­ |
| å£°æ˜æ ¼å¼ | `NodeOutput(source_act=èŠ‚ç‚¹ID, source_key=è¾“å‡ºå­—æ®µå)` |

### å®Œæ•´æµç¨‹

```python
# 1. å‰ä¸€ä¸ªèŠ‚ç‚¹è¾“å‡ºæ•°æ®
data.outputs.commit_id = 'abc123'

# 2. åœ¨å…¨å±€æ•°æ®ä¸­å£°æ˜å¼•ç”¨
pipeline_data.inputs['${commit_id}'] = NodeOutput(
    source_act=git_act.id,
    source_key='commit_id'
)

# 3. åä¸€ä¸ªèŠ‚ç‚¹å¼•ç”¨å˜é‡
value={'commit_id': '${commit_id}'}
```

**è¿™ä¸‰æ­¥ç¼ºä¸€ä¸å¯ï¼**

### è®°å¿†å£è¯€

```
èŠ‚ç‚¹è¾“å‡ºè¦å¼•ç”¨ï¼Œ
NodeOutput æ¥å¸®å¿™ï¼Œ
source_act æŒ‡èŠ‚ç‚¹ï¼Œ
source_key æ‰¾å­—æ®µï¼Œ
å…¨å±€å£°æ˜ä¸èƒ½å¿˜ï¼
```

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [å˜é‡æ¸²æŸ“ä¸Schemaä½¿ç”¨æŒ‡å—](./å˜é‡æ¸²æŸ“ä¸Schemaä½¿ç”¨æŒ‡å—.md)
- [Jenkinsä»»åŠ¡æ‰§è¡Œç»„ä»¶å¼€å‘æŒ‡å—](./Jenkinsä»»åŠ¡æ‰§è¡Œç»„ä»¶å¼€å‘æŒ‡å—.md)
- [Pipeline Treeç»“æ„è¯¦è§£](./Pipeline_Treeç»“æ„è¯¦è§£.md)

---

## â“ å¸¸è§é—®é¢˜ FAQ

### Q1: å¯ä»¥å¼•ç”¨å¤šä¸ªèŠ‚ç‚¹çš„è¾“å‡ºå—ï¼Ÿ

**A**: å¯ä»¥ï¼ä¸ºæ¯ä¸ªè¾“å‡ºå£°æ˜ä¸€ä¸ª NodeOutput å³å¯ã€‚

```python
pipeline_data.inputs['${output1}'] = NodeOutput(source_act=act1.id, source_key='key1')
pipeline_data.inputs['${output2}'] = NodeOutput(source_act=act2.id, source_key='key2')
pipeline_data.inputs['${output3}'] = NodeOutput(source_act=act3.id, source_key='key3')
```

### Q2: å¯ä»¥å¼•ç”¨åŒä¸€ä¸ªèŠ‚ç‚¹çš„å¤šä¸ªè¾“å‡ºå­—æ®µå—ï¼Ÿ

**A**: å¯ä»¥ï¼ä¸ºæ¯ä¸ªå­—æ®µå£°æ˜ä¸€ä¸ª NodeOutputã€‚

```python
pipeline_data.inputs['${commit_id}'] = NodeOutput(
    source_act=git_act.id,
    source_key='commit_id'
)
pipeline_data.inputs['${commit_message}'] = NodeOutput(
    source_act=git_act.id,
    source_key='commit_message'
)
```

### Q3: NodeOutput çš„ type å‚æ•°æœ‰ä»€ä¹ˆç”¨ï¼Ÿ

**A**: æ§åˆ¶å˜é‡çš„æ¸²æŸ“è¡Œä¸ºã€‚é€šå¸¸ä½¿ç”¨ `Var.SPLICE`ï¼Œè¿™æ ·å¦‚æœè¾“å‡ºå€¼ä¸­åŒ…å«å˜é‡å¼•ç”¨ä¹Ÿèƒ½è¢«æ¸²æŸ“ã€‚

### Q4: å¦‚æœèŠ‚ç‚¹æ²¡æœ‰è¾“å‡ºå¯¹åº”çš„å­—æ®µä¼šæ€æ ·ï¼Ÿ

**A**: å˜é‡å€¼ä¼šæ˜¯ `None` æˆ–ç©ºï¼Œå¯èƒ½å¯¼è‡´åç»­èŠ‚ç‚¹æ‰§è¡Œå¤±è´¥ã€‚å»ºè®®åœ¨ç»„ä»¶ä¸­åšå¥½é”™è¯¯å¤„ç†ã€‚

### Q5: å¯ä»¥åœ¨å¹¶è¡Œåˆ†æ”¯ä¸­å¼•ç”¨èŠ‚ç‚¹è¾“å‡ºå—ï¼Ÿ

**A**: å¯ä»¥ï¼Œä½†è¦æ³¨æ„æ‰§è¡Œé¡ºåºã€‚åªæœ‰å½“æºèŠ‚ç‚¹æ‰§è¡Œå®Œæˆåï¼ŒNodeOutput æ‰ä¼šæœ‰å€¼ã€‚

---

å¸Œæœ›è¿™ä»½æ–‡æ¡£èƒ½å¸®åŠ©ä½ æ­£ç¡®ä½¿ç”¨èŠ‚ç‚¹è¾“å‡ºå¼•ç”¨åŠŸèƒ½ï¼ğŸ‰

